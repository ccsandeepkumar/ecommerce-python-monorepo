version: 2.1
 
setup: true
 
orbs:
  continuation: circleci/continuation@0.4.0
 
jobs:
  # -------------------------------
  # Step 1: Continuation Setup Job
  # -------------------------------
  detect-and-continue:
    docker:
      - image: cimg/python:3.10
 
    steps:
      - checkout
 
      - continuation/continue:
          configuration_path: .circleci/continue.yml
 
  # ---------------------------------------------
  # Step 2: Run Only Changed Test Files + Logs
  # ---------------------------------------------
  run-tests-and-save-logs:
    docker:
      - image: cimg/python:3.10
 
    steps:
      - checkout
 
      # ✅ Install pytest
      - run:
          name: Install Test Dependencies
          command: |
            pip install pytest
 
      # ✅ Run pytest ONLY for committed/changed test files
      - run:
          name: Run Only Changed Tests and Save Logs
          command: |
            echo "Detecting changed test files..."
 
            # Get changed files from last commit
            CHANGED_TESTS=$(git diff --name-only HEAD~1 HEAD | grep -E "tests/.*\.py$" || true)
 
            # If no test files changed, skip pytest
            if [ -z "$CHANGED_TESTS" ]; then
              echo "No test files changed in this commit."
              echo "NO_TESTS_CHANGED" > pytest.log
            else
              echo "Changed test files detected:"
              echo "$CHANGED_TESTS"
 
              echo "Running pytest only for changed files..."
              pytest $CHANGED_TESTS > pytest.log 2>&1 || true
            fi
 
      # ✅ Verify pytest.log exists
      - run:
          name: Verify Log File Exists
          command: |
            if [ -f pytest.log ]; then
              echo "pytest.log created successfully"
              head -30 pytest.log
            else
              echo "ERROR: pytest.log was NOT created"
              exit 1
            fi
 
      # ✅ Upload pytest.log artifact (Tool fetches this)
      - store_artifacts:
          path: pytest.log
          destination: pytest.log
 
workflows:
  setup-workflow:
    jobs:
      - detect-and-continue
 
      - run-tests-and-save-logs:
          requires:
            - detect-and-continue
