version: 2.1
 
setup: true
 
orbs:
  continuation: circleci/continuation@0.4.0
 
jobs:
  # -----------------------------------
  # Step 1: Continuation Setup Job
  # -----------------------------------
  detect-and-continue:
    docker:
      - image: cimg/python:3.10
 
    steps:
      - checkout
 
      - continuation/continue:
          configuration_path: .circleci/continue.yml
 
  # ---------------------------------------------
  # Step 2: Run Tests + Save Logs + Save Changes
  # ---------------------------------------------
  run-tests-and-save-artifacts:
    docker:
      - image: cimg/python:3.10
 
    steps:
      - checkout
 
      # ✅ Install dependencies
      - run:
          name: Install Dependencies
          command: |
            pip install -r requirements.txt
            pip install pytest
 
      # ✅ Capture changed files list + full diff
      - run:
          name: Capture Final Changed Files
          command: |
            echo "Saving changed file list..."
            git diff --name-only HEAD~1 HEAD > changed_files.txt
 
            echo "Saving full diff of final changes..."
            git diff HEAD~1 HEAD > final_changes.diff
 
            echo "Changed files:"
            cat changed_files.txt
 
      # ✅ Run tests and save logs
      - run:
          name: Run Tests and Save Logs
          command: |
            echo "Running pytest..."
            pytest tests/ > pytest.log 2>&1 || true
            echo "Pytest finished"
 
      # ✅ Upload all artifacts
      - store_artifacts:
          path: pytest.log
          destination: pytest.log
 
      - store_artifacts:
          path: changed_files.txt
          destination: changed_files.txt
 
      - store_artifacts:
          path: final_changes.diff
          destination: final_changes.diff
 
workflows:
  setup-workflow:
    jobs:
      - detect-and-continue
 
      - run-tests-and-save-artifacts:
          requires:
            - detect-and-continue
